<!DOCTYPE html>
<html>

<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
<script src="https://unpkg.com/leaflet@latest/dist/leaflet.js"></script>
<script src="../src/leaflet-search.css" type="text/css" rel="stylesheet"></script>
<script src="../src/leaflet-search.js" type="text/javascript"></script>
<script src="../src/leaflet-wfst.min.js" type="text/javascript"></script>
<script src="https://cdn.rawgit.com/hayeswise/Leaflet.PointInPolygon/v1.0.0/wise-leaflet-pip.js"></script>

<style type="text/css">
    .search-cancel span {
        display: none;
    }

    .leaflet-control-search .search-tooltip {
        position: absolute;
        top: 100%;
        min-width: 120px;
        max-height: 122px;
        box-shadow: 1px 1px 6px rgba(0, 0, 0, 0.4);
        background-color: rgb(255, 255, 255);
        z-index: 1010;
        overflow-y: auto;
        overflow-x: hidden;
        cursor: pointer;
    }

    #searchtext20 {
        padding: 5px;
        border-radius: 5px;
        border: 3px solid #04AA6D;
    }

    h1 {
        color: #04AA6D;
    }

    button[type=submit] {
        background-color: #04AA6D;
        padding: 4px;
        border: 1px solid black;
        border-radius: 4px;
        font-weight: 700;
        color: wheat;
    }

    #map {
        height: 500px;
        width: 100%;
        border: 1px solid black;
    }

    #table {
        width: 100%;
    }

    #data {
        font-family: Arial, Helvetica, sans-serif;
        border-collapse: collapse;
        
        margin: 10px;
    }

    #data td,
    #data th {
        border: 1px solid #ddd;
        padding: 8px;
    }

    #data th {
        padding-top: 12px;
        padding-bottom: 12px;
        text-align: left;
        background-color: #04AA6D;
        color: wheat
    }
</style>

<head>
    <title>Padrones UABID</title>
</head>

<body>
    <div id="logout" style="position:absolute; right: 20px">
        <form action="/logout?_method=DELETE" method="POST">
            <button type="submit">Cerrar sesión</button>
        </form>
    </div>

    <h1>Búsqueda de padrones especiales</h1>
    <div>
        <p>Buscar por número de padrón o clickear en alguno para obtener su información, muestra la información de un
            padrón a la vez.</p>
    </div>
    <div id="map">
        <script type="text/javascript">

            var map = L.map('map').setView([-34.83, -56.21], 11);
            document.getElementById('map').style.cursor = 'auto'



            var capa_base = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
            });
            capa_base.addTo(map);
            
            const wfstPointOptions = {
                crs: L.CRS.EPSG4326,
                showExisting: true,
                geometryField: 'the_geom',
                url: `http://geoserver.montevideo.gub.uy/geoserver/ide/wfs?service=WFS&version=1.1.0&request=getCapabilities`,
                typeNS: 'v_sb_bienes_depto',
                typeName: 'v_sb_bienes_depto',
                style: function (layer) {
                    return {
                        color: '#9a1f1f',
                        weight: 1
                    }
                },
                filter: new L.Filter.Like('the_geom','*', { wildCard: '*', matchCase: false})
            };

            var capa_padrones_wfs = new L.WFS(wfstPointOptions).addTo(map);

            var capas_busqueda = L.layerGroup([capa_padrones_wfs]);
            var searchControl = map.addControl(new L.Control.Search({
                layer: capa_padrones_wfs,
                propertyName: 'padron',
                textPlaceholder: 'Busqueda de padrones',
                collapsed: false,
                moveToLocation: function (latlng, title, map) {
                    map.setView(latlng, 16);
                    WFStoHTML(latlng.layer.feature.properties);
                }
            }));

            map.on('click', function (ev) {
                var array = Object.entries(capa_padrones_wfs._layers);
                array.some(function (element) {
                    if (element[1]._bounds.contains(ev.latlng)) {
                        WFStoHTML(element[1].feature.properties);
                        return true;
                    }
                });
            }
            );

            function WFStoHTML(obj) {
                var result = Object.keys(obj).map((key) => [`<th>${key}</th>`, `<td>${obj[key]}</td>`]);
                document.getElementById("row-title").innerHTML = "";
                document.getElementById("row-data").innerHTML = "";
                for (var i = 0; i < result.length; i++) {
                    document.getElementById("row-title").innerHTML += result[i][0];
                }
                for (var i = 0; i < result.length; i++) {
                    document.getElementById("row-data").innerHTML += result[i][1];
                }
            }
        </script>
    </div>
    <div id="table">
        <table id="data">
            <tr id="row-title"></tr>
            <tr id="row-data"></tr>
        </table>
    </div>
</body>

</html>